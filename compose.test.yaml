name: lottery-test

services:
  web:
    image: nginx
    ports:
      - "127.0.0.1:8081:80" # Different port to avoid conflicts
    volumes:
      - ./nginx/templates:/etc/nginx/templates:ro
    environment:
      - SITENAME=localhost
    depends_on:
      - backend
      - frontend

  frontend:
    build:
      context: frontend
      target: production
    env_file: test.env

  backend:
    build:
      context: backend
      target: production
    env_file: test.env
    command: >
      sh -c "
        python manage.py migrate &&
        python manage.py runserver 0.0.0.0:8000
      "

  cypress:
    image: cypress/included:13.6.1
    env_file: test.env
    volumes:
      - ./cypress:/e2e
    working_dir: /e2e
    entrypoint: ["tail", "-f", "/dev/null"]
    depends_on:
      - web
      - frontend
      - backend
